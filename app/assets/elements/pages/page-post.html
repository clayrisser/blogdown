<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="page-post">
  <template>
    
    <paper-card heading="[[post.title]]">
      <template is="dom-if" if="[[isMD]]" restamp>
        <div class="card-content">
          <juicy-markdown value="[[postResponseData]]"></juicy-markdown>
        </div>
      </template>
      <template is="dom-if" if="[[isHTML]]" restamp>
        <div class="card-content">
          <template is="juicy-html" content$="[[postResponseData]]"></template>
        </div>
      </template>
      <template is="dom-if" if="[[isPDF]]" restamp>
        <div class="card-content">
          <pdf-object file="[[postUrl]]" height="400px"></pdf-object>
        </div>
        <div class="card-actions">
          <paper-button on-click="_download">Fullscreen</paper-button>
        </div>
      </template>
    </paper-card>
    
    <!-- Disqus commenting -->
    <template is="dom-if" if="[[enableDisqus]]" restamp>
      <paper-card heading="Commenting">
        <div class="card-content">
          <service-disqus
            shortname="[[disqusShortname]]"
            identifier="[[post.datestamp]]"
            title="[[post.title]]"
            url="[[url]]"
            categoryId="[[categoryId]]"
            https=false
          ></service-disqus>
        </div>
      </paper-card>
    </template>
    
    <iron-ajax id="post"
      url="[[postUrl]]"
      handle-as="text"
      on-response="postResponse"
      on-error="postError"
      last-response="{{postResponseData}}"
    ></iron-ajax>
    
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'page-post',
        
        properties: {
          post: {
            type: Object,
            observer: '_postChanged'
          }
        },
        
        _postChanged: function() {
          this.set('enableDisqus', false);
          this.postUrl = '../../content/posts/' + this.post.slug + '.' + this.post.format;
          if (this.post.format === 'md' || this.post.format === 'html') {
            this.$.post.generateRequest();
          } else {
            this._loadPost();
          }
        },
        
        postResponse: function() {
          this._loadPost();
        },
        
        postError: function() {
          var error = 'Error 2: ' + this.post.slug + '.' + this.post.format + ' failed to load';
          app.debug(error, 'warn');
          app.toast(error, 'http://blogdown.info/error/2', '_blank');
        },
        
        _loadPost: function() {
          switch (this.post.format) {
            case 'md':
              this._isMD();
              break;
            case 'html':
              this._isHTML();
              break;
            case 'pdf':
              this._isPDF();
              break;
            default:
              app.debug('invalid post case', 'warn');
          }
        },
        
        _isMD: function() {
          this.isMD = true;
          this.isHTML = false;
          this.isPDF = false;
          this._contentLoaded();
        },
        
        _isHTML: function() {
          this.isMD = false;
          this.isHTML = true;
          this.isPDF = false;
          this._contentLoaded();
        },
        
        _isPDF: function() {
          this.isMD = false;
          this.isHTML = false;
          this.isPDF = true;
          this._contentLoaded();
        },
        
        _contentLoaded: function() {
          this._loadDisqus();
        },
        
        _loadDisqus: function() {
          if (app.settings.disqusShortname) {
            this.set('disqusShortname', app.settings.disqusShortname);
            this.set('url', window.location.href);
            this.set('categoryId', '');
            window.setTimeout(function() { // Delays enableDisqus long enough to allow restamping
              this.set('enableDisqus', true);
            }.bind(this), 1);
          }
          this._postLoaded();
        },
        
        _postLoaded: function() {
          app.debug(this.post.slug + '.' + this.post.format + ' loaded');
        },
        
        _download: function() {
          window.open(this.postUrl);
        }
      });
    })();
  </script>

</dom-module>
