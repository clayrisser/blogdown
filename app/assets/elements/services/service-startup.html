<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="service-startup">
  <template>

    <!-- Load posts -->
    <iron-ajax id="posts"
      url="../../../content/posts.json"
      handle-as="json"
      on-response="postsResponse"
      on-error="postsError"
      last-response="{{postsResponseData}}"
    ></iron-ajax>

  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'service-startup',

        ready: function() {
          this._buildPageArray();
        },
        
        _buildPageArray: function() {
          this.pages = [];
          var hardPages = app.settings.hardPages;
          var softPages = app.settings.softPages;
          for (var i = 0; i < hardPages.length; i++) { // Add hard pages
            var slug = hardPages[i].title.toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
            var route = '';
            if (slug === 'home') {
              route = '/';
            } else {
              route = '/' + slug;
            }
            var page = {
              title: hardPages[i].title,
              route: route,
              slug: slug,
              type: "hard",
              addToMenu: hardPages[i].addToMenu
            };
            this.push('pages', page);
          }
          for (var i = 0; i < softPages.length; i++) { // Add soft pages
            var slug = softPages[i].title.toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
            var route = '/' + slug;
            var format ="md"
            if (softPages[i].format) {
              format = softPages[i].format;
            }
            page = {
              title: softPages[i].title,
              route: route,
              slug: slug,
              type: "soft",
              format: format,
              addToMenu: hardPages[i].addToMenu
            };
            this.push('pages', page);
          }
          app.pages = this.pages;
          this.$.posts.generateRequest();
        },

        postsResponse: function() {
          if (this.postsResponseData) {
            this.posts = [];
            var posts = this.postsResponseData;
            for (var i = 0; i < posts.length; i++) {
//            var slug = posts[i].title.toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
              var format = 'md';
              if (posts[i].format) {
                format = posts[i].format;
              }
              var post = {
                title: posts[i].title,
                datestamp: posts[i].datestamp,
                author: posts[i].author,
                slug: posts[i].datestamp,
                format: format
              };
              this.push('posts', post);
            }
            app.posts = this.posts;
          } else {
            var error = 'Error 2: SyntaxError in posts.json';
            app.toast(error);
            app.debug(error, 'warn');
          }
          this._loadElement(app.settings.theme);
        },

        postsError: function() {
          app.debug('Posts failed to load', 'warn');
          this._loadElement(app.settings.theme);
        },
        
        _loadElement: function(name) {
          this.importHref('../assets/elements/themes/theme-' + name + '.html', function() {
            app.debug('theme-' + name + ' loaded');
            this._loaded();
          }.bind(this), function() {
            var error = 'Error 1: ' + name + ' theme failed to load';
            app.debug(error, 'warn');
            app.toast(error, 'http://blogdown.info/error/1', '_blank');
            this._loaded();
          }.bind(this));
        },

        _loaded: function() {
          var event = new Event('application-loaded');
          window.dispatchEvent(event);
          app.loaded = true;
          app.debug(app.settings.title + ' loaded');
        }
      });
    })();
  </script>

</dom-module>
