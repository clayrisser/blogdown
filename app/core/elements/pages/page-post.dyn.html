<link rel="import" href="../custom/service-disqus.dyn.html">

<dom-module id="page-post">
  <template>
    <style>
      .featured-image {
        --paper-card-header-text: {
          color: white;
          font-size: 30px;
          font-weight: bold;
        }
        --paper-card-header-image: {
          opacity: .5;
          max-height: 300px;
        }
        --paper-card-header: {
          background-color: black;
        }
      }
    </style>

    <!-- Has featured image -->
    <template is="dom-if" if="[[featuredImage]]" restamp>
      <paper-card class="featured-image" heading="[[post.title]]" image="[[featuredImage]]">
        <template is="dom-if" if="[[isMD]]" restamp>
          <div class="card-content">
            <juicy-markdown value="[[postResponseData]]"></juicy-markdown>
          </div>
        </template>
        <template is="dom-if" if="[[isHTML]]" restamp>
          <div class="card-content">
            <template is="juicy-html" content$="[[postResponseData]]"></template>
          </div>
        </template>
        <template is="dom-if" if="[[isPDF]]" restamp>
          <div class="card-content">
            <pdf-object file="[[postUrl]]" height="400px"></pdf-object>
          </div>
          <div class="card-actions">
            <paper-button on-click="_download">Fullscreen</paper-button>
          </div>
        </template>
      </paper-card>
    </template>

    <!-- No featured image -->
    <template is="dom-if" if="[[!featuredImage]]" restamp>
      <paper-card heading="[[post.title]]">
        <template is="dom-if" if="[[isMD]]" restamp>
          <div class="card-content">
            <juicy-markdown value="[[postResponseData]]"></juicy-markdown>
          </div>
        </template>
        <template is="dom-if" if="[[isHTML]]" restamp>
          <div class="card-content">
            <template is="juicy-html" content$="[[postResponseData]]"></template>
          </div>
        </template>
        <template is="dom-if" if="[[isPDF]]" restamp>
          <div class="card-content">
            <pdf-object file="[[postUrl]]" height="400px"></pdf-object>
          </div>
          <div class="card-actions">
            <paper-button on-click="_download">Fullscreen</paper-button>
          </div>
        </template>
      </paper-card>
    </template>

    <!-- Disqus commenting -->
    <template is="dom-if" if="[[enableDisqus]]" restamp>
      <paper-card heading="Commenting">
        <div class="card-content">
          <service-disqus
            shortname="[[disqusShortname]]"
            identifier="[[post.datestamp]]"
            title="[[post.title]]"
            url="[[url]]"
            categoryId="[[categoryId]]"
            https=false
          ></service-disqus>
        </div>
      </paper-card>
    </template>

    <iron-ajax id="post"
      url="[[postUrl]]"
      handle-as="text"
      on-response="postResponse"
      on-error="postError"
      last-response="{{postResponseData}}"
    ></iron-ajax>

  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'page-post',

        properties: {
          post: {
            type: Object,
            observer: '_postChanged'
          },
          fileKnown: {
            type: Boolean,
            value: false
          }
        },

        _postChanged: function() {
          this.set('enableDisqus', false);
          this._determinePost();
        },

        _determinePost: function() {
          var formats = ['md', 'html', 'pdf'];
          this._formats = [this.post.format];
          for (var i = 0; i < formats.length; i++) {
            if (formats[i] != this.post.format) {
              this.push('_formats', formats[i]);
            }
          }
          if (app.settings.permlinkMode === 'date') { // date mode
            var checkFileArray = [];
            _.each(this._formats, function(format) {
              var url = app.rootURL + 'content/posts/' + this.post.slug + '.' + format;
              checkFileArray.push(this._checkFile.bind(this, url, format));
            }.bind(this));
            this._title = this.post.title.toString().toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
            _.each(this._formats, function(format) {
              var url = app.rootURL + 'content/posts/' + this._title + '.' + this._formats[0];
              checkFileArray.push(this._checkFile.bind(this, url, format));
            }.bind(this));
            var promiseChain = Promise.resolve();
            for (var checkFile of checkFileArray) {
              promiseChain = promiseChain.then(checkFile);
            }
          } else { // title mode
            var checkFileArray = [];
            _.each(this._formats, function(format) {
              var url = app.rootURL + 'content/posts/' + this.post.slug + '.' + format;
              checkFileArray.push(this._checkFile.bind(this, url, format));
            }.bind(this));
            _.each(this._formats, function(format) {
              var url = app.rootURL + 'content/posts/' + this.post.datestamp + '.' + format;
              checkFileArray.push(this._checkFile.bind(this, url, format));
            }.bind(this));
            var promiseChain = Promise.resolve();
            for (var checkFile of checkFileArray) {
              promiseChain = promiseChain.then(checkFile);
            }
            promiseChain.catch(function(err) {
              console.warn(err);
            });
          }
        },

        _initPost: function() {
          if (this.post.format === 'md' || this.post.format === 'html') {
            this.$.post.generateRequest();
          } else {
            this._loadPost();
          }
          this._determineFeaturedImage();
        },

        postResponse: function() {
          this._loadPost();
        },

        postError: function() {
          var error = 'Error 2: ' + this.post.slug + '.' + this.post.format + ' failed to load';
          app.debug(error, 'warn');
          app.toast(error, 'http://blogdown.info/error/2', '_blank');
        },

        _loadPost: function() {
          switch (this.post.format) {
            case 'md':
              this._isMD();
              break;
            case 'html':
              this._isHTML();
              break;
            case 'pdf':
              this._isPDF();
              break;
            default:
              app.debug('invalid post case', 'warn');
          }
        },

        _isMD: function() {
          this.isMD = true;
          this.isHTML = false;
          this.isPDF = false;
          this._contentLoaded();
        },

        _isHTML: function() {
          this.isMD = false;
          this.isHTML = true;
          this.isPDF = false;
          this._contentLoaded();
        },

        _isPDF: function() {
          this.isMD = false;
          this.isHTML = false;
          this.isPDF = true;
          this._contentLoaded();
        },

        _determineFeaturedImage: function() {
          if (this.post.featuredImage) {
            this._featuredImage = false;
            if (this.post.featuredImage === true) { // Featured image assumed
              if (app.settings.permlinkMode === 'date') { // date mode
                this._featuredImage = app.rootURL + 'content/images/' + this.post.slug + '.jpg';
                this._checkImage(this._featuredImage, function() { // Image exists
                  this.featuredImage = this._featuredImage;
                }.bind(this), function() { // Image doesn't exist
                  this._featuredImage = app.rootURL + 'content/images/' + this.post.slug + '.png';
                  this._checkImage(this._featuredImage, function() { // Image exists
                    this.featuredImage = this._featuredImage;
                  }.bind(this), function() { // Image doesn't exist
                    this._title = this.post.title.toString().toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
                    this._featuredImage = app.rootURL + 'content/images/' + this._title + '.jpg';
                    this._checkImage(this._featuredImage, function() { // Image exists
                      this.featuredImage = this._featuredImage;
                    }.bind(this), function() { // Image doesn't exist
                      this._featuredImage = app.rootURL + 'content/images/' + this._title + '.png';
                      this._checkImage(this._featuredImage, function() { // Image exists
                        this.featuredImage = this._featuredImage;
                      }.bind(this), function() { // Image doesn't exist
                        this.featuredImage = false;
                      }.bind(this));
                    }.bind(this));
                  }.bind(this));
                }.bind(this));
              } else { // title mode
                this._featuredImage = app.rootURL + 'content/images/' + this.post.slug + '.jpg';
                this._checkImage(this._featuredImage, function() { // Image exists
                  this.featuredImage = this._featuredImage;
                }.bind(this), function() { // Image doesn't exist
                  this._featuredImage = app.rootURL + 'content/images/' + this.post.slug + '.png';
                  this._checkImage(this._featuredImage, function() { // Image exists
                    this.featuredImage = this._featuredImage;
                  }.bind(this), function() { // Image doesn't exist
                    this._featuredImage = app.rootURL + 'content/images/' + this.post.datestamp + '.jpg';
                    this._checkImage(this._featuredImage, function() { // Image exists
                      this.featuredImage = this._featuredImage;
                    }.bind(this), function() { // Image doesn't exist
                      this._featuredImage = app.rootURL + 'content/images/' + this.post.datestamp + '.png';
                      this._checkImage(this._featuredImage, function() { // Image exists
                        this.featuredImage = this._featuredImage;
                      }.bind(this), function() { // Image doesn't exist
                        this.featuredImage = false;
                      }.bind(this));
                    }.bind(this));
                  }.bind(this));
                }.bind(this));
              }
            } else {
              if (this._isRelativeUrl(this.post.featuredImage)) { // Relative featured image
                this._featuredImage = app.rootURL + 'content/images/' + this.post.featuredImage;
              } else { // Absolute featured image
                this._featuredImage = this.post.featuredImage;
              }
              this._checkImage(this._featuredImage, function() { // Image exists
                this.featuredImage = this._featuredImage;
              }.bind(this), function() { // Image doesn't exist
                this.featuredImage = false;
              }.bind(this));
            }
          } else {
            this.featuredImage = false;
          }
        },

        _contentLoaded: function() {
          this._loadDisqus();
        },

        _loadDisqus: function() {
          if (app.settings.disqusShortname) {
            this.set('disqusShortname', app.settings.disqusShortname);
            this.set('url', window.location.href);
            this.set('categoryId', '');
            window.setTimeout(function() { // Delays enableDisqus long enough to allow restamping
              this.set('enableDisqus', true);
            }.bind(this), 1);
          }
          this._postLoaded();
        },

        _postLoaded: function() {
          app.debug(this.post.slug + '.' + this.post.format + ' loaded');
        },

        _download: function() {
          window.open(this.postUrl);
        },

        _isRelativeUrl: function(url) {
          var regex = new RegExp('^(?:[a-z]+:)?//', 'i');
          if (regex.test(url)) { // absolute url
            return false;
          } else { // relative url
            return true;
          }
        },

        _checkFile: function(url, format) {
          return new Promise(function(resolve, reject) {
            if (this.fileKnown) {
              resolve();
            } else {
              var xhr = document.createElement('iron-request');
              xhr.send({url: url}).then(function(response) {
                if (response.succeeded) {
                    console.log(response.xhr);
                    this.fileKnown = true;
                    this.postUrl = url;
                    this.post.format = format;
                    this._initPost();
                }
                resolve();
              }.bind(this)).catch(function(err) {
                resolve();
              });
            }
          }.bind(this));
        },

        _checkImage: function(image, success, error) {
          var img = new Image();
          img.onload = success;
          img.onerror = error;
          img.src = image;
        }
      });
    })();
  </script>

</dom-module>
