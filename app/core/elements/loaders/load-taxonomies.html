<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="load-taxonomies">
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'load-taxonomies',

        load: function() {
          app.log.debug('loading taxonomies . . .');
          var promises = _.map(app.settings.taxonomies, (taxonomy) => {
            return this._loadTaxonomy(taxonomy);
          });
          return Promise.all(promises).then((taxonomiesMeta) => {
            var taxonomies = {};
            _.each(taxonomiesMeta, (taxonomy) => {
              taxonomies[taxonomy.name] = taxonomy.posts;
            });
            app.set('taxonomies', taxonomies);
            app.log.info('app.taxonomies =>');
            app.log.info(app.taxonomies);
            return taxonomies;
          });
        },

        _loadTaxonomy: function(taxonomy) {
          return fetch('../../../content/' + taxonomy + '.json')
            .then((res) => {
              return res.json();
            }).then((body) => {
              return this._getTaxonomyMeta(taxonomy, body);
            });
        },

        _getTaxonomyMeta: function(taxonomy, posts) {
          var taxonomyPosts = [];
          _.each(posts, function(post) {
            var date = false;
            if (post.date) {
              if (typeof post.date === 'number') {
                date = moment.unix(post.date);
              } else {
                var date = moment(new Date(post.date));
              }
            }
            var title = false;
            if (post.title) {
              title = post.title;
            } else if (post.author) {
              title = changeCase.titleCase(taxonomy) + ' by ' + post.author;
            } else if (date) {
              title = changeCase.titleCase(taxonomy) + ' on ' + date.format(app.settings.dateFormat);
            }
            taxonomyPosts.push({
              title: title,
              slug: post.slug ? post.slug : (title ? changeCase.paramCase(title) : false),
              date: date,
              author: post.author ? post.author : false,
              featuredImage: post.featuredImage ? post.featuredImage : false,
              description: post.description ? post.description : false
            });
          });
          return {
            name: taxonomy,
            posts: taxonomyPosts
          }
        }
      });
    })();
  </script>
</dom-module>
