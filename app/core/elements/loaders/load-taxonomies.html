<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="load-taxonomies">
  <template>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'load-taxonomies',

        load: function() {
          app.taxonomies = {};
          var promise = _.map(app.settings.taxonomies, function(taxonomy) {
            return this.loadTaxonomy(taxonomy);
          }.bind(this));
          return Promise.all(promise).then(function(taxonomies) {
            return app.taxonomies;
          }).catch(function(err) {
            throw err;
          })
        },

        loadTaxonomy: function(taxonomy) {
          return new Promise(function(resolve, reject) {
            var xhr = document.createElement('iron-request');
            xhr.send({
              url: '../../../content/' + taxonomy + '.json'
            }).then(function(res) {
              if (res.status === 200) {
                this.storeTaxonomyPosts(taxonomy, JSON.parse(res.response));
                resolve(res.response);
              } else {
                reject(res.response);
              }
            }.bind(this)).catch(function(err) {
              reject(err);
            });
          }.bind(this));
        },

        storeTaxonomyPosts: function(taxonomy, posts) {
          app.taxonomies[taxonomy] = [];
          _.each(posts, function(post) {
            var date = false;
            if (post.date) {
              if (typeof post.date === 'number') {
                date = moment.unix(post.date);
              } else {
                var date = moment(new Date(post.date));
              }
            }
            var title = false;
            if (post.title) {
              title = post.title;
            } else if (post.author) {
              title = changeCase.titleCase(taxonomy) + ' by ' + post.author;
            } else if (date) {
              title = changeCase.titleCase(taxonomy) + ' on ' + date.format(app.settings.dateFormat);
            }
            app.taxonomies[taxonomy].push({
              title: title,
              slug: post.slug ? post.slug : (title ? changeCase.paramCase(title) : false),
              date: date,
              author: post.author ? post.author : false,
              featuredImage: post.featuredImage ? post.featuredImage : false,
              description: post.description ? post.description : false
            });
          });
          return app.taxonomies[taxonomy];
        }
      });
    })();
  </script>
</dom-module>
