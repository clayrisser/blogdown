<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="load-theme">
  <template>

    <template id="theme" is="dom-if" if="[[themeLoaded]]" restamp>
      <the-theme
        narrow="{{narrow}}"
        loading="[[loading]]"
        progress="[[progress]]"
        page-title="[[pageTitle]]"
        route-data="[[routeData]]">
      </the-theme>
    </template>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'load-theme',

        properties: {
          themeLoaded: {
            type: Boolean,
            value: false
          },
          narrow: {
            type: Boolean,
            notify: true
          }
        },

        ready: function() {
          this.resolveRequest = app.temporaryResolveRequest;
          this.rejectRequest = app.temporaryRejectRequest;
        },

        attached: function() {
          this.stampTheme();
        },

        load: function() {
          return new Promise(function(resolve, reject) {
            app.temporaryResolveRequest = resolve; // very hacky solution
            app.temporaryRejectRequest = reject; // very hacky solution
          }.bind(this));
        },

        stampTheme: function() {
          var themeName = app.getLocal('settings.theme') || app.settings.theme;
          this.loadElement(themeName).then(function() {
            this.themeLoaded = true;
            this.resolveRequest();
          }.bind(this)).catch(function() {
            this.rejectRequest();
          }.bind(this));
        },

        loadElement: function(theme) {
          return new Promise(function(resolve, reject) {
            this.importHref('../../../content/themes/' + theme + '/the-theme.html', function() {
              resolve();
            }.bind(this), function(err) {
              reject(err);
            }.bind(this));
          }.bind(this));
        }
      });
    })();
  </script>
</dom-module>
