<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="service-content">
  <template>
    
    <template is="dom-if" if="[[_isEqual(route, 'home')]]" restamp>
      <page-home></page-home>
    </template>
    
    <template is="dom-if" if="[[_isEqual(route, 'posts')]]" restamp>
      <page-posts></page-posts>
    </template>
    
    <template is="dom-if" if="[[_isEqual(route, 'search')]]" restamp>
        <page-search></page-search>
    </template>
    
    <template is="dom-if" if="[[_isEqual(route, 'contact')]]" restamp>
        <page-contact></page-contact>
    </template>
    
    <template is="dom-if" if="[[_isEqual(route, '404')]]" restamp>
        <page-404></page-404>
    </template>
    
    <template is="dom-if" if="[[_isEqual(route, 'soft')]]" restamp>
        <page-soft page="[[softPage]]"></page-soft>
    </template>
    
    <template is="dom-if" if="[[_isEqual(route, 'customhard')]]" restamp>
        <page-customhard page="[[customhardPage]]"></page-customhard>
    </template>
    
    <template is="dom-if" if="[[_isEqual(route, 'post')]]" restamp>
       <page-post post="[[post]]"></page-post>
    </template>
    
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'service-content',
        
        properties: {
          routeData: {
            type: Object,
            observer: 'routeChanged'
          },
          staticPages: {
            type: Array,
            value: [
              "404",
              "loading"
            ]
          }
        },
        
        routeChanged: function() {
          var hashId = this._checkForHashId();
          if (hashId !== '') { // strips hashId from route
            app.set('hashId', hashId);
            app.debug('app.hashId = ' + app.hashId);
          } else {
            var parameters = this._checkForParameters();
            if (parameters.length > 0) { // strips parameters from route
              app.set('parameters', parameters);
              app.debug('app.parameters =');
              app.debug(app.parameters);
            } else if (this.routeData.slugs[0] !== this.previousRoute) { // route is new and is clean from hashes and parameters
              switch (this.routeData.type) {
                case 'home':
                  this._homeRoute();
                  break;
                case 'page':
                  this._pageRoute();
                  break;
                case 'child':
                  this._childRoute();
                  break;
                default:
                  this._404Route();
                  break;
              }
              this.set('previousRoute', this.routeData.slugs[0]);
            }
          }
        },

        _checkForHashId: function() {
          var hashId = '';
          var url = window.location.href;
          var hashes = 0;
          for (var i = 0; i < url.length; i++) {
            if (url[i] === '#') {
              hashes++;
              if (hashes > 1) { // If hash id added to end of url
                hashId = url.substring(i + 1, url.length);
                app.goTo(url.substring(url.indexOf('#') + 2, i));
              }
            }
          }
          return hashId;
        },
        
        _checkForParameters: function() {
          var parameters = [];
          var url = window.location.href;
          var location = url.indexOf('?');
          if (location > 0) {
            var paramString = url.substring(location + 1, url.length);
            var name = '';
            var value = '';
            var mode = 'name'
            for (var i = 0; i <= paramString.length; i++) {
              if (i < paramString.length) {
                if (mode === 'name') { // Parse name
                  if (paramString[i] !== '=') {
                    name = name + paramString[i];
                  } else {
                    mode = 'value';
                    continue;
                  }
                } else { // Parse value
                  if (paramString[i] !== '&') {
                    value = value + paramString[i];
                  } else {
                    var parameter = {
                      name: name,
                      value: value
                    };
                    parameters.push(parameter);
                    name = '';
                    value = '';
                    mode = 'name';
                  }
                }
              } else { // Add last parameter to list
                if (name !== '') {
                  var parameter = {
                    name: name,
                    value: value
                  };
                  parameters.push(parameter);
                }
              }
            }
            app.goTo(url.substring(url.indexOf('#') + 2, location));
          }
          return parameters;
        },
        
        _homeRoute: function() {
          this.set('route', 'home');
          this._loadElement('home');
        },
        
        _pageRoute: function() {
          var validPage = false;
          for (var i = 0; i < app.pages.length; i++) {
            if (this.routeData.slugs.page === app.pages[i].slug) {
              if (app.pages[i].type === 'permanent-hard') { // Permanant hard page
                this.set('route', this.routeData.slugs.page);
                this._loadElement(this.routeData.slugs.page);
              } else if (app.pages[i].type === 'custom-hard') { // Custom hard page
                this.set('customhardPage', app.pages[i]);
                this.set('route', 'customhard');
                this._loadElement('customhard');
              } else { // Soft page
                this.set('softPage', app.pages[i]);
                this.set('route', 'soft');
                this._loadElement('soft');
              }
              validPage = true;
              break;
            }
          }
          if (!validPage) {
            this.set('route', '404');
          }
        },
        
        _childRoute: function() {
          var validPage = false;
          if (this.routeData.slugs.page === 'post') { // Posts route
            for (var i = 0; i < app.posts.length; i++) {
              if (this.routeData.slugs.child === String(app.posts[i].slug)) {
                this.set('post', app.posts[i]);
                this.set('route', this.routeData.slugs.page);
                this._loadElement(this.routeData.slugs.page);
                validPage = true;
              }
            }
          }
          if (!validPage) {
            this.set('route', '404');
          }
        },
        
        _404Route: function() {
          this.set('route', '404');
        },
        
        _loadElement: function(name) {
          var dynamic = true;
          for (var i = 0; i < this.staticPages.length; i++) {
            if (name === this.staticPages[i]) {
              dynamic = false;
              break;
            }
          }
          if (dynamic) {
            name = name + '.dyn';
          }
          this.importHref(app.rootURL + 'core/elements/pages/page-' + name + '.html', function() {
            app.debug('page-' + name + '.html was imported.');
          }.bind(this), function() {
              window.history.back();
              app.debug('WARNING: page-' + name + '.html import failed to load');
              app.toast('WARNING: page-' + name + '.html import failed to load');
          }.bind(this));
        },
        
        _isEqual: function(a, b) {
          return a === b;
        }
      });
    })();
  </script>

</dom-module>
