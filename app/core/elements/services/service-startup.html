<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="service-startup">
  <template>

    <!-- Load posts -->
    <iron-ajax id="posts"
      url="../../../content/posts.json"
      handle-as="json"
      on-response="postsResponse"
      on-error="postsError"
      last-response="{{postsResponseData}}"
    ></iron-ajax>

  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'service-startup',

        ready: function() {
          this._buildPageArray();
        },
        
        _buildPageArray: function() {
          this.pages = [];
          var hardPages = app.settings.hardPages;
          var softPages = app.settings.softPages;
          for (var i = 0; i < hardPages.length; i++) { // Add hard pages
            var slug = hardPages[i].title.toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
            var route = '';
            if (slug === 'home') {
              route = '/';
            } else {
              route = '/' + slug;
            }
            // Determin hard page title
            var title = app.title;
            if (hardPages[i].rename) {
              title = hardPages[i].rename;
            } else {
              title = hardPages[i].title;
            }
            // Determine hard page type
            var type = 'custom-hard';
            var permanentHardPages = ['home', 'search', 'posts'];
            for (var j = 0; j < permanentHardPages.length; j++) {
              if (slug === permanentHardPages[j]) {
                type = 'permanent-hard';
                break;
              }
            }
            var page = {
              title: title,
              route: route,
              slug: slug,
              type: type,
              addToMenu: hardPages[i].addToMenu
            };
            this.push('pages', page);
          }
          for (var i = 0; i < softPages.length; i++) { // Add soft pages
            var slug = softPages[i].title.toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
            var route = '/' + slug;
            var format ="md"
            if (softPages[i].format) {
              format = softPages[i].format;
            }
            page = {
              title: softPages[i].title,
              route: route,
              slug: slug,
              type: "soft",
              format: format,
              addToMenu: softPages[i].addToMenu
            };
            this.push('pages', page);
          }
          app.pages = this.pages;
          this.$.posts.generateRequest();
        },

        postsResponse: function() {
          if (this.postsResponseData) {
            this.posts = [];
            var posts = this.postsResponseData;
            for (var i = 0; i < posts.length; i++) {
              if (posts[i].status !== 'draft' && posts[i].status !== 'unpublished') { // Post is active
                var pushPost = true;
                // Title
                var title = 'Untitled Post'
                if (!posts[i].title) {
                  permlinkMode = 'date';
                } else {
                  title = posts[i].title;
                }
                // Datestamp
                var datestamp = '0000000000000';
                if (posts[i].date) {
                  datestamp = Number(moment.unix(new Date(posts[i].date))).toString();
                }
                // Author
                var author = 'No Author';
                if (posts[i].author) {
                  author = posts[i].author;
                }
                // Slug
                var slug = null;
                if (app.settings.permlinkMode === 'date') { // date mode
                  if (posts[i].date) {
                    slug = posts[i].date.toString().toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
                  } else { // Prevents errors when a title and date stamp were not given
                    pushPost = false;
                  }
                } else { // title mode
                  slug = posts[i].title.toString().toLowerCase().replace(/[^\s\w+\-_#.]/g, '').replace(/\s+/g, '-');
                }
                // Format
                var format = 'md';
                if (posts[i].format) {
                  format = posts[i].format;
                }
                // Featured image
                var featuredImage = true;
                if (posts[i].featuredImage === false) { // Finding featured image location happens in page-post.dyn.html
                  featuredImage = posts[i].featuredImage;
                }
                var post = {
                  title: title,
                  datestamp: datestamp,
                  author: author,
                  slug: slug,
                  format: format,
                  featuredImage: featuredImage
                };
                if (pushPost) {
                  this.push('posts', post);
                }
              }
            }
            app.posts = this.posts;
          } else {
            var error = 'Error 2: SyntaxError in posts.json';
            app.toast(error);
            app.debug(error, 'warn');
          }
          this._loadElement(app.settings.theme);
        },

        postsError: function() {
          app.debug('Posts failed to load', 'warn');
          this._loadElement(app.settings.theme);
        },
        
        _loadElement: function(name) {
          this.importHref('../../../../../../../../core/elements/themes/theme-' + name + '.dyn.html', function() {
            app.debug('theme-' + name + ' loaded');
            this._loaded();
          }.bind(this), function() {
            var error = 'Error 1: ' + name + ' theme failed to load';
            app.debug(error, 'warn');
            app.toast(error, 'http://blogdown.info/error/1', '_blank');
            this._loaded();
          }.bind(this));
        },

        _loaded: function() {
          var event = new Event('application-loaded');
          window.dispatchEvent(event);
          app.loaded = true;
          app.debug(app.settings.title + ' loaded');
        }
      });
    })();
  </script>

</dom-module>
