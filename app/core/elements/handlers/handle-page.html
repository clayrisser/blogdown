<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="handle-page">
  <template>

    <template is="dom-if" if="[[booleanFormat.md]]" restamp>
      <marked-element markdown="[[body]]">
        <div class="markdown-html"></div>
      </marked-element>
    </template>

    <template is="dom-if" if="[[booleanFormat.html]]" restamp>
      <template is="juicy-html" content$="[[body]]"></template>
    </template>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'handle-page',

        behaviors: [ ReduxBehavior ],

        properties: {
          page: {
            type: Object,
            value: {},
            observer: 'pageChanged'
          },
          fileKnown: {
            type: Boolean,
            value: false
          },
          booleanFormat: {
            type: Object,
            value: {}
          },
          body: {
            type: String,
            value: ''
          },
          settings: {
            type: Object,
            statePath: 'settings'
          }
        },

        pageChanged: function() {
          this.set('fileKnown', false);
          this.set('format', {});
          this.set('body', '');
          if (this.page.slug) this._loadPage(this.page);
        },

        _loadPage: function(page) {
          var formats = [page.format];
          _.each([
            'md',
            'html',
            'pdf'
          ], (format) => {
            if (format !== page.format) formats.push(format);
          });
          var promises = [];
          _.each(formats, (format) => {
            var url = app.rootURL + 'content/pages/' + page.slug + '.' + format;
            promises.push(this._getFile.bind(this, url, format));
          });
          var promiseChain = Promise.resolve();
          _.each(promises, (promise) => {
            promiseChain = promiseChain.then(promise);
          });
          promiseChain.then(() => {
            this._setBooleanFormat(this.format);
          }).catch((err) => {
            app.log.error(err);
          });
        },

        _getFile: function(url, format) {
          if (this.fileKnown) return Promise.resolve();
          return fetch(url).then((res) => {
            if (res.status === 404) return '';
            if (res.status >= 200 && res.status < 500) {
              this.set('fileKnown', true);
              this.set('format', format);
              return res.text();
            }
            var err = new Error('Error gettings file');
            err.res = res;
            throw err;
          }).then((body) => {
            this.set('body', body);
            return;
          });
        },

        _setBooleanFormat: function(format) {
          var temp = {};
          temp[format] = true;
          this.set('booleanFormat', temp);
        }
      });
    })();
  </script>
</dom-module>
