<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="handle-content">
  <template>

    <template is="dom-if" if="[[_isEqual(route.type, 'parent')]]" restamp>
      <handle-parent page="[[page]]"></handle-parent>
    </template>

    <template is="dom-if" if="[[_isEqual(route.type, 'child')]]" restamp>
      <handle-child post="[[post]]"></handle-child>
    </template>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'handle-content',

        behaviors: [ ReduxBehavior, ReduxActions ],

        properties: {
          route: {
            type: Object,
            statePath: 'route',
            observer: 'routeChanged'
          },
          pages: {
            type: Array,
            statePath: 'pages'
          },
          taxonomies: {
            type: Object,
            statePath: 'taxonomies'
          },
          appLoaded: {
            type: Boolean,
            statePath: 'meta.appLoaded',
            observer: 'routeChanged'
          },
          previousRoute: {
            type: Object,
            value: {}
          }
        },

        routeChanged: function() {
          if (this.appLoaded && this.route.slugs) {
            if (!this.previousRoute.slugs || this.route.slugs.parent !== this.previousRoute.slugs.parent ||
                this.route.slugs.child !== this.previousRoute.slugs.child) {
              this.dispatch('appLoading', true);
              switch(this.route.type) {
                case 'parent':
                  var page = _.filter(this.pages, (page) => {
                    return page.slug === this.route.slugs.parent;
                  })[0];
                  if (page) {
                    this.set('page', page);
                  } else {
                    app.log.warn('404 error');
                    app.go.to('/404');
                  }
                  break;
                case 'child':
                  var post = _.filter(this.taxonomies[this.route.slugs.parent], (post) => {
                    return post.slug === this.route.slugs.child;
                  })[0];
                  if (post) {
                    this.set('post', post);
                  } else {
                    app.log.warn('404 error');
                    app.go.to('/404');
                  }
                  break;
                default:
                  app.log.warn('404 error');
                  app.go.to('/404');
                  break;
              }
              this.set('previousRoute', this.route);
            }
          }
        },

        _isEqual: function(left, right) {
          return left === right;
        }
      });
    })();
  </script>
</dom-module>
