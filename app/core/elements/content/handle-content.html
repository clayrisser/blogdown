<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="handle-content">
  <template>

    <template is="dom-if" if="[[_isEqual(contentType, 'page')]]" restamp>
      <theme-page page="[[page]]"><theme-page>
    </template>

    <template is="dom-if" if="[[_isEqual(contentType, 'post')]]" restamp>
      <theme-post post="[[post]]"><theme-post>
    </template>

    <template is="dom-if" if="[[_isEqual(contentType, 'posts')]]" restamp>
      <theme-posts page="[[page]]" posts="[[posts]]"><theme-posts>
    </template>

  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'handle-content',

        behaviors: [
          ReduxBehavior,
          ReduxActions
        ],

        actions: {
          setHashId: function(hashId) {
            return {
              type: SET_HASH_ID,
              hashId: hashId
            };
          }
        },

        properties: {
          route: {
            type: Object,
            statePath: 'route',
            observer: 'routeChanged'
          },
          pages: {
            type: Array,
            statePath: 'pages'
          },
          taxonomies: {
            type: Object,
            statePath: 'taxonomies'
          },
          appLoaded: {
            type: Boolean,
            statePath: 'meta.appLoaded',
            observer: 'routeChanged'
          },
          previousRoute: {
            type: Object,
            value: {}
          },
          contentType: {
            type: String,
            value: ''
          }
        },

        routeChanged: function() {
          if (this.appLoaded) {
            if (this._setHashId()) return;
            if (this.route.slugs) {
              if (!this.previousRoute.slugs || this.route.slugs.parent !== this.previousRoute.slugs.parent ||
                  this.route.slugs.child !== this.previousRoute.slugs.child) {
                this.dispatch('appLoading', true);
                switch(this.route.type) {
                  case 'parent':
                    var page = _.filter(this.pages, (page) => {
                      return page.slug === this.route.slugs.parent;
                    })[0];
                    if (page) {
                      this.set('page', page);
                    } else {
                      app.log.warn('404 error');
                      app.go.to('/404');
                    }
                    if (page.taxonomy) {
                      this.set('posts', this.taxonomies[this.page.slug]);
                      this.dispatch('appLoading', false);
                      this.set('contentType', 'posts');
                    } else {
                      this.set('contentType', 'page');
                    }
                    break;
                  case 'child':
                    var post = _.filter(this.taxonomies[this.route.slugs.parent], (post) => {
                      return post.slug === this.route.slugs.child;
                    })[0];
                    if (post) {
                      this.set('post', post);
                    } else {
                      app.log.warn('404 error');
                      app.go.to('/404');
                    }
                    this.set('contentType', 'post');
                    break;
                  default:
                    app.log.warn('404 error');
                    app.go.to('/404');
                    break;
                }
                this.set('previousRoute', this.route);
              }
            }
          }
        },

        _setHashId: function() {
          var url = window.location.href;
          var hashLocation = url.indexOf('#', url.indexOf('#') + 1);
          var hashId = false;
          if (hashLocation >= 0) {
            hashId = url.substring(hashLocation + 1, url.length);
          }
          if (hashId) {
            this.dispatch('setHashId', hashId);
            app.go.to(url.substring(url.indexOf('/#!') + 3, hashLocation));
          }
          return hashId;
        },

        _isEqual: function(left, right) {
          return left === right;
        }
      });
    })();
  </script>
</dom-module>
