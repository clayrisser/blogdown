<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="page-post">
  <template>
    
    <paper-card heading="[[post.title]]">
      <template is="dom-if" if="[[isMD]]" restamp>
        <div class="card-content">
          <juicy-markdown value="[[postResponseData]]"></juicy-markdown>
        </div>
      </template>
      <template is="dom-if" if="[[isHTML]]" restamp>
        <div class="card-content">
          <template is="juicy-html" content$="[[postResponseData]]"></template>
        </div>
      </template>
      <template is="dom-if" if="[[isPDF]]" restamp>
        <div class="card-content">
          <pdf-object file="[[postUrl]]" height="400px"></pdf-object>
        </div>
        <div class="card-actions">
          <paper-button on-click="_download">Fullscreen</paper-button>
        </div>
      </template>
    </paper-card>
    
    <!-- Disqus commenting -->
    <div id="disqus">
      <template is="dom-if" if="[[enableDisqus]]">
        <paper-card heading="Commenting">
          <div class="card-content">
            <service-disqus
              shortname="[[disqusShortname]]"
              identifier="[[post.datestamp]]"
              title="[[post.title]]"
              url="[[url]]"
              categoryId="[[categoryId]]"
              https=false
            ></service-disqus>
          </div>
        </paper-card>
      </template>
    </div>
    
    <iron-ajax id="post"
      url="[[postUrl]]"
      handle-as="text"
      on-response="postResponse"
      on-error="postError"
      last-response="{{postResponseData}}"
    ></iron-ajax>
    
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'page-post',
        
        properties: {
          postResponseData: {
            type: String
          },
          post: {
            type: Object,
            observer: '_postChanged'
          }
        },
        
        attached: function() {
          app.addEventListener('hash-id', function() {
            this._checkForHashId();
          }.bind(this));
        },
        
        _postChanged: function() {
          this.set('enableDisqus', false);
          this.postUrl = '../../posts/' + this.post.slug + '.' + this.post.format;
          if (this.post.format === 'md' || this.post.format === 'html') {
            this.$.post.generateRequest();
          } else {
            this._loadPost();
          }
        },
        
        postResponse: function() {
          this._loadPost();
        },
        
        postError: function() {
          var error = 'Error 2: ' + this.post.slug + '.' + this.post.format + ' failed to load';
          app.debug(error, 'warn');
          app.toast(error, 'http://blogdown.info/error/2', '_blank');
        },
        
        _loadPost: function() {
          switch (this.post.format) {
            case 'md':
              this.isMD = true;
              this.isHTML = false;
              this.isPDF = false;
              break;
            case 'html':
              this.isMD = false;
              this.isHTML = true;
              this.isPDF = false;
              break;
            case 'pdf':
              this.isMD = false;
              this.isHTML = false;
              this.isPDF = true;
              break;
          }
          this._loadDisqus();
          app.debug(this.post.slug + '.' + this.post.format + ' loaded');
        },
        
        _loadDisqus: function() {
          if (app.settings.disqusShortname) {
            this.set('disqusShortname', app.settings.disqusShortname);
            this.set('url', window.location.href.replace('/#', ''));
            this.set('categoryId', '');
            this.set('enableDisqus', true);
            window.setTimeout(function() { /* ! this can be implemented better */
              this._checkForHashId(); // check for hash id here becuase hash-id event has already fired
            }.bind(this), 1000);
          }
        },
        
        _checkForHashId: function() {
          if (app.hashId && this.enableDisqus) { // if #comment, scroll to comment section
            if (app.hashId.indexOf('comment') >= 0) {
              this.$.disqus.scrollIntoView();
            }
          }
        },
        
        _download: function() {
          window.open(this.postUrl);
        }
      });
    })();
  </script>

</dom-module>
