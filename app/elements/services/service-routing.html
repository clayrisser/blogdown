<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="service-routing">
  <template>
    
    <excess-route route="/" on-properties-changed="_homePropertiesChanged"></excess-route>
    <excess-route route="/:page" page="{{pageSlug}}" on-properties-changed="_pagePropertiesChanged"></excess-route>
    <excess-route route="/:page/" page="{{pageSlug}}" on-properties-changed="_pagePropertiesChanged"></excess-route>
    <excess-route route="/:page/:child" page="{{pageSlug}}" child="{{childSlug}}" on-properties-changed="_childPropertiesChanged"></excess-route>
    <excess-route route="/:page/:child/" page="{{pageSlug}}" child="{{childSlug}}" on-properties-changed="_childPropertiesChanged"></excess-route>
    
    <!-- Hard pages -->
    <restamp-page route-type="page" current-routetype="[[routeType]]" slug="home" current-slug="[[pageSlug]]" page-type="hard" current-pagetype="[[pageType]]">
      <page-home></page-home>
    </restamp-page>
    
    <restamp-page route-type="page" current-routetype="[[routeType]]" slug="posts" current-slug="[[pageSlug]]" page-type="hard" current-pagetype="[[pageType]]">
      <page-posts></page-posts>
    </restamp-page>
    
    <restamp-page route-type="page" current-routetype="[[routeType]]" slug="contact" current-slug="[[pageSlug]]" page-type="hard" current-pagetype="[[pageType]]">
      <page-contact></page-contact>
    </restamp-page>
    <!-- End hard pages -->
    
    <restamp-page route-type="404" current-routetype="[[routeType]]" slug="404" current-slug="404" page-type="hard" current-pagetype="hard">
      <page-404></page-404>
    </restamp-page>
    
    <restamp-page route-type="page" current-routetype="[[routeType]]" slug="soft" current-slug="soft" page-type="soft" current-pagetype="[[pageType]]">
      <page-soft page="[[softPage]]"></page-soft>
    </restamp-page>
    
    <restamp-page route-type="post" current-routetype="[[routeType]]" slug="post" current-slug="post" page-type="na" current-pagetype="na">
      <page-post post="[[post]]"></page-post>
    </restamp-page>
    
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'service-routing',
        
        properties: {
          _attached: {
            type: Boolean,
            value: false
          }
        },
        
        attached: function() {
          if (!this._attached) {
            this._attached = true;
            this.initializePage();
          }
        },
        
        _homePropertiesChanged: function() {
          app.goTo('/home');
        },
        
        _pagePropertiesChanged: function() {
          if (this._checkForHashId() === '' || // _checkForHashId() may redirect page
            this._checkForParameters().length > 0) { // _checkForParameters() may redirect page
            this.set('routeType', 'page');
            this.initializePage();
          }
        },
        
        _childPropertiesChanged: function() {
          if (this._checkForHashId() === '' || // _checkForHashId() may redirect page
            this._checkForParameters().length > 0) { // _checkForParameters() may redirect page
            this.set('routeType', 'child');
            this.initializePage();
          }
        },

        _checkForHashId: function() {
          var hashId = '';
          var url = window.location.href;
          var hashes = 0;
          for (var i = 0; i < url.length; i++) {
            if (url[i] === '#') {
              hashes++;
              if (hashes > 1) { // If hash id added to end of url
                var event = new Event('hash-id');
                hashId = url.substring(i + 1, url.length);
                app.set('hashId', hashId);
                app.goTo(url.substring(url.indexOf('#') + 1, i));
                app.debug('app.hashId: ' + app.hashId);
                app.dispatchEvent(event);
              }
            }
          }
          return hashId;
        },
        
        _checkForParameters: function() {
          var parameters = [];
          var url = window.location.href;
          var location = url.indexOf('?');
          if (location > 0) {
            var paramString = url.substring(location + 1, url.length);
            var name = '';
            var value = '';
            var mode = 'name'
            for (var i = 0; i <= paramString.length; i++) {
              if (i < paramString.length) {
                if (mode === 'name') { // Parse name
                  if (paramString[i] !== '=') {
                    name = name + paramString[i];
                  } else {
                    mode = 'value';
                    continue;
                  }
                } else { // Parse value
                  if (paramString[i] !== '&') {
                    value = value + paramString[i];
                  } else {
                    var parameter = {
                      name: name,
                      value: value
                    };
                    parameters.push(parameter);
                    name = '';
                    value = '';
                    mode = 'name';
                  }
                }
              } else { // Add last parameter to list
                if (name !== '') {
                  var parameter = {
                    name: name,
                    value: value
                  };
                  parameters.push(parameter);
                }
              }
            }
            app.goTo(url.substring(url.indexOf('#') + 1, location));
          }
          if (parameters.length > 0) {
            var event = new Event('parameters');
            app.set('parameters', parameters);
            app.debug('app.parameters:');
            app.debug(app.parameters);
            app.dispatchEvent(event);
          }
          return parameters;
        },
        
        initializePage: function() {
          if (this._attached && (this.previousPageSlug !== this.pageSlug || // Prevents restamping before page is attached
            this.previousChildSlug !== this.childSlug)) { // Prevents restamping of the current page
            var validPage = false;
            if (this.routeType === 'page') { // Page route
              for (var i = 0; i < app.pages.length; i++) {
                if (this.pageSlug === app.pages[i].slug) {
                  if (app.pages[i].type === 'hard') { // Hard page
                    this.set('pageType', 'hard');
                  } else { // Soft page
                    this.set('pageType', 'soft');
                    this.set('softPage', app.pages[i]);
                  }
                  validPage = true;
                  break;
                }
              }
            } else if (this.routeType === 'child') { // Posts route
              this.routeType = this.pageSlug;
              if (this.routeType === 'post') { // Posts route
                for (var i = 0; i < app.posts.length; i++) {
                  if (String(app.posts[i].slug) === this.childSlug) {
                    this.post = app.posts[i];
                    validPage = true;
                  }
                }
              }
            } else {
              app.debug('routeType not specified', 'warn');
            }
            if (validPage) {
              this.set('previousPageSlug', this.pageSlug);
              this.set('previousChildSlug', this.childSlug);
              this.restampPages();
            } else { // Page does not exist
              if (app.firstPage) {
                this.set('routeType', '404');
                this.restampPages();
              } else {
                var error = 'Error 404: page does not exist';
                app.debug(error, 'warn');
                app.toast(error, 'http://blogdown.info/error/404', '_blank');
              }
            }
          }
        },
          
        restampPages: function() {
          if (document.getElementsByTagName('restamp-page')[0]) {
            var restampPages = document.getElementsByTagName('restamp-page');
            for (var i = 0; i < restampPages.length; i++) {
              restampPages[i].restamp();
            }
          }
        }
      });
    })();
  </script>

</dom-module>
